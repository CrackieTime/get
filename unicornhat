#!/bin/bash

confirm () {
        read -r -p "$1 [y/N] " response < /dev/tty
        response=${response,,}
        if [[ $response =~ ^(yes|y)$ ]]; then
                true
        else
                false
        fi
}

pip_pkg_req3 () {
        PIP_CHK=$(pip-3.2 search $1 | grep INSTALLED)
        if [ "" == "$PIP_CHK" ]; then
                true
        else
                false
        fi
}

pip_pkg_req () {
        PIP_CHK=$(pip search $1 | grep INSTALLED)
        if [ "" == "$PIP_CHK" ]; then
                true
        else
                false
        fi
}

apt_pkg_req () {
        APT_CHK=$(dpkg-query -W --showformat='${Status}\n' $1|grep "install ok installed")
        if [ "" == "$APT_CHK" ]; then
                true
        else
                false
        fi
}

success () {
        echo "$(tput setaf 2)$1$(tput sgr0)"
}

warning () {
        echo "$(tput setaf 1)$1$(tput sgr0)"
}

IS_RASPBIAN=`cat /etc/*-release | grep Raspbian`

if [[ "" == $IS_RASPBIAN ]]; then
	warning "Warning!"
	echo "Please only run this script on Raspbian on your Raspberry Pi"
	exit 1;
fi


echo ""
echo "This script will install Unicorn Hat libraries"
echo "and dependencies for both Python 2 and 3."
echo ""
echo "This process may take several minutes."
echo ""
warning "--- Warning ---"
echo ""
echo "Always be careful when running scripts and commands"
echo "copied from the internet. Ensure they are from a"
echo "trusted source."
echo ""
echo "If you want to see what this script does before"
echo "running it, you should run:"
echo "    \curl -sS get.pimoroni.com/unicornhat"
echo ""
echo ""

if confirm "Do you wish to continue?"; then

	echo ""
	echo "Checking install requirements..."
	echo ""
	if apt_pkg_req "python-pip" || apt_pkg_req "python-dev" || apt_pkg_req "python3-pip" || apt_pkg_req "python3-dev"; then

		echo "Updating package indexes..."
		sudo apt-get update
	
		echo ""
		echo "Installing UnicornHat requirements..."

		\curl -sS get.pimoroni.com/package | bash -s - "python-pip"
		\curl -sS get.pimoroni.com/package | bash -s - "python-dev"
		\curl -sS get.pimoroni.com/package | bash -s - "python3-pip"
		\curl -sS get.pimoroni.com/package | bash -s - "python3-dev"
	else
	
		success "Found!"

	fi

	echo ""
	echo "Checking for Python 2 library..."

	if pip_pkg_req "unicornhat"; then

		echo ""
		echo "Installing UnicornHat for Python 2..."
		if ! sudo pip install unicornhat; then
			warning "Python 2 library install failed!"
			echo ""
			exit
		fi
		success "Done!"

	else
		
		echo ""
		success "Found!"
		echo ""
		if confirm "Python 2 module found. Reinstall/Update?"; then
			if ! sudo pip install unicornhat -I; then
				warning "Python 2 library install failed!"
				echo ""
				exit
			fi
			success "Done!"
		fi

	fi

	echo ""
	echo "Checking for Python 3 library..."

	if pip_pkg_req3 "unicornhat"; then

		echo ""
		echo "Installing UnicornHat for Python 3..."
		if ! sudo pip-3.2 install unicornhat; then
			warning "Python 3 library install failed!"
			echo ""
			exit
		fi
	
	else

		echo ""
		success "Found!"
		echo ""
		if confirm "Python 3 module found. Reinstall/Update?"; then
			if ! sudo pip-3.2 install unicornhat -I; then
				warning "Python 3 library install failed!"
				echo ""
				exit
			fi
		fi

	fi

	echo ""
	echo "Checking for additional modules..."
	
	if pip_pkg_req "flask"; then
		echo ""
		echo "Unicorn Paint requires the Flask python module ( Python 2.x only )"
		if confirm "Would you like to install it?"; then
			echo ""
			sudo pip install flask
		fi
	else
		echo ""
		success "Found!"
	fi

	echo ""
	if confirm "Would you like to download Unicorn Hat example code?"; then

		echo ""
		echo "Downloading to $(pwd)/unicornhat"
		echo ""
		git clone https://github.com/pimoroni/unicornhat

		echo ""
		success "All done!"
		echo ""
		echo "For examples"
		echo "see $(pwd)/unicornhat/python/examples"
		echo "Have fun!"
		echo ""

	else
	
		echo ""
		success "All done!"
		echo ""
		echo "For examples"
		echo "see https://github.com/pimoroni/UnicornHat/tree/master/python/examples"
		echo "And visit forums.pimoroni.com for support"	
		echo "Have fun!"
		echo ""

	fi

else
	echo ""
	echo "Aborting..."
	echo ""
fi
