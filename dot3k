#!/bin/bash

# This boilerplate get script does nothing
# but serves as an example for making your own.
# Run with -y switch to skip confirmation and intro.

if ! [[ $1 == '-y' ]]
then

	echo ""
	echo "This script will install dot3k and dependencies"
	echo ""
	echo "--- Warning ---"
	echo ""
	echo "Always be careful when running scripts and commands"
	echo "copied from the internet. Ensure they are from a"
	echo "trusted source."
	echo ""
	echo "If you want to see what this script does before"
	echo "running it, you should run:"
	echo "    \curl -sS get.pimoroni.com/dot3k"
	echo ""
	echo ""

	read -r -p "Do you wish to continue? [y/N] " response < /dev/tty
response=${response,,}

fi

if [[ $response =~ ^(yes|y)$ ]] || [[ $1 == '-y' ]]
then

	echo ""
	read -r -p "Dot3k requires SPI and I2C, enable now? [Y/n] " response < /dev/tty
	response=${response,,}
	
	if [[ $response =~ ^(yes|y)$ ]]
	then

		\curl -sS get.pimoroni.com/spi | bash -s - "-y"
		\curl -sS get.pimoroni.com/i2c | bash -s - "-y"

	fi

	PIP_OK=$(dpkg-query -W --showformat='${Status}\n' python-pip|grep "install ok installed")
	
	SMBUS_OK=$(dpkg-query -W --showformat='${Status}\n' python-smbus|grep "install ok installed")

	DEV_OK=$(dpkg-query -W --showformat='${Status}\n' python-dev|grep "install ok installed")

	if [ "" == "$PIP_OK" ] || [ "" == "$SMBUS_OK" ] || [ "" == "$DEV_OK" ]; then

		echo ""
		echo "One or more requires packages not found..."
		echo ""
		echo "Updating package indexes..."
		echo ""
		sudo apt-get update

		echo ""
		echo "Installing required packages..."
		echo ""
		sudo apt-get --force-yes --yes install python-dev python-pip python-smbus
	fi

	echo ""
	echo "Checking for Python modules..."
	DOT3K_OK=$(pip search dot3k | grep INSTALLED)
	
	if [ "" == "$PIP_OK" ]; then

		echo ""
		echo "Insalling Python module"
		echo ""

		sudo pip install dot3k -I
	
	else
	
		echo ""
		echo "Python modules already installed"

		read -r -p "do you want to update them? [Y/n] " response < /dev/tty
		response=${response,,}

		if [[ $response =~ ^(yes|y)$ ]]; then

			echo ""
			sudo pip install dot3k -I
			echo ""

		fi
	fi

	echo ""

	read -r -p "Would you like to download Dot3k example code? [Y/n] " response < /dev/tty
	response=${response,,}

	if [[ $response =~ ^(yes|y)$ ]]
	then

		echo ""
		echo "Downloading to $(pwd)/dot3k"
		echo ""
		git clone https://github.com/pimoroni/dot3k

	fi

	sudo python -c $'import dot3k\n\ndot3k.backlight.rgb(0,255,0)\ndot3k.lcd.clear()\ndot3k.lcd.write("Install CompleteHave fun!")' >> /dev/null 2>&1
	echo ""
	echo "All done!"
	echo "Enjoy your new Display-o-Tron 3000!"
	echo ""
	echo "Note: Dot3k currently supports Python 2 only."
	echo ""

else
	echo ""
	echo "Aborting..."
	echo ""
fi
